import React from 'react'
import { useOutletContext } from 'react-router-dom'
import './Dashboard.css'
import DashBoardInventory from './components/DashBoardInventory'
import Selector from './components/Selector'
import { useState } from 'react'

function Dashboard() {
  //states
  const [filter, setFilter] = useState('')

  // context
  const {users, products} = useOutletContext()
  
  //rendering
  const mappedUser = users.map(user=>{
    return(<h2>Hello <span>{user.name}ðŸ‘‹. Welcome back</span></h2>)
  })

  // variables
  const filteredProducts=products.filter(pro=>{
    if(filter==="") return true
    return pro.category === filter
  }) 

  const nonDuplicateCategory = [... new Set(products.map(item=>item.category))]//avoid duplicates

  // functions
  function calculateSummary(data){
      let TotalStock = 0
      let totalDemand = 0
      let totalSales = 0 
      let totalAlerts = 0
      data.forEach(item=>{
          totalDemand+=item.demand_forecast||0
          TotalStock+=item.stock||0
          if(item.alerts&&item.alerts.length>0){
              totalAlerts+=item.alerts.length
          }
          if(item.sales&&item.sales.length>0){
              totalSales+=item.sales.reduce((sum, sales)=>sum+sales.unitsSold,0)
          }
      })
      return {TotalStock, totalDemand, totalSales, totalAlerts}
  }
  const {TotalStock, totalDemand, totalSales, totalAlerts} = calculateSummary(products)


  function handleFilter(filter){
    setFilter(filter)
  }

  return (
    <main className='dashboard-main'>
      <div className='dashboard-head'>
        <h1>Invertory OverView</h1>
        {mappedUser}
      </div>
      <section className='dashboard-forecast'>
        <h3>Real-time and Demand Forecast</h3>
        <div className='dashboard-forecast-cards'>
          <div>
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M416 224C398.3 224 384 209.7 384 192C384 174.3 398.3 160 416 160L576 160C593.7 160 608 174.3 608 192L608 352C608 369.7 593.7 384 576 384C558.3 384 544 369.7 544 352L544 269.3L374.6 438.7C362.1 451.2 341.8 451.2 329.3 438.7L224 333.3L86.6 470.6C74.1 483.1 53.8 483.1 41.3 470.6C28.8 458.1 28.8 437.8 41.3 425.3L201.3 265.3C213.8 252.8 234.1 252.8 246.6 265.3L352 370.7L498.7 224L416 224z"/></svg>
              <p>Total Stocks</p>
            </span>
            <p>{TotalStock}</p>
          </div>

          <div>
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M552 120C552 106.7 541.3 96 528 96C514.7 96 504 106.7 504 120L504 520C504 533.3 514.7 544 528 544C541.3 544 552 533.3 552 520L552 120zM424 192C410.7 192 400 202.7 400 216L400 520C400 533.3 410.7 544 424 544C437.3 544 448 533.3 448 520L448 216C448 202.7 437.3 192 424 192zM344 312C344 298.7 333.3 288 320 288C306.7 288 296 298.7 296 312L296 520C296 533.3 306.7 544 320 544C333.3 544 344 533.3 344 520L344 312zM216 384C202.7 384 192 394.7 192 408L192 520C192 533.3 202.7 544 216 544C229.3 544 240 533.3 240 520L240 408C240 394.7 229.3 384 216 384zM112 448C98.7 448 88 458.7 88 472L88 520C88 533.3 98.7 544 112 544C125.3 544 136 533.3 136 520L136 472C136 458.7 125.3 448 112 448z"/></svg>
              <p>Predicted Demand</p>
            </span>
            <p>{totalDemand}</p>
          </div>

          <div>
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M320 576C178.6 576 64 461.4 64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576zM320 384C302.3 384 288 398.3 288 416C288 433.7 302.3 448 320 448C337.7 448 352 433.7 352 416C352 398.3 337.7 384 320 384zM320 192C301.8 192 287.3 207.5 288.6 225.7L296 329.7C296.9 342.3 307.4 352 319.9 352C332.5 352 342.9 342.3 343.8 329.7L351.2 225.7C352.5 207.5 338.1 192 319.8 192z"/></svg>
              <p>Low-stock Alerts</p>
            </span>
            <p>{totalAlerts}</p>
          </div>

          <div>
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M256 144C256 117.5 277.5 96 304 96L336 96C362.5 96 384 117.5 384 144L384 496C384 522.5 362.5 544 336 544L304 544C277.5 544 256 522.5 256 496L256 144zM64 336C64 309.5 85.5 288 112 288L144 288C170.5 288 192 309.5 192 336L192 496C192 522.5 170.5 544 144 544L112 544C85.5 544 64 522.5 64 496L64 336zM496 160L528 160C554.5 160 576 181.5 576 208L576 496C576 522.5 554.5 544 528 544L496 544C469.5 544 448 522.5 448 496L448 208C448 181.5 469.5 160 496 160z"/></svg>
              <p>Sales Velocity</p>
            </span>
            <p>{totalSales}</p>
          </div>
        </div>
      </section>
      <section className='dashboard-chart'>
        <h3>Stocks Chart</h3>
      </section>
      <section>
        <h3>Inventrory Table</h3>
        <Selector nonDuplicateCategory={nonDuplicateCategory} onFilter={handleFilter}/>
        <DashBoardInventory filteredProducts={filteredProducts}/>
      </section>
    </main>
  )
}

export default Dashboard